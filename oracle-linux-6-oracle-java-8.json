{
  "description": "oracle java 8 packer template",

  "variables": {
    "name": "oracle-java-8",
    "base_name": "oracle-linux-6",

    "user_home": "{{env `HOME`}}",

    "docker_user": "jeqo",
    "atlas_user": "jeqo",
    "atlas_token": "{{env `ATLAS_TOKEN`}}",

    "version": "8.66",
    "timestamp": "{{isotime \"20060102150405\"}}"
  },

  "builders": [{
    "name": "virtualbox",
    "type": "virtualbox-ovf",

    "vm_name": "{{user `name`}}",
    "output_directory": "{{user `user_home`}}/boxes/{{user `atlas_user`}}/{{user `name`}}",
    "source_path": "{{user `user_home`}}/boxes/{{user `atlas_user`}}/{{user `base_name`}}/{{user `base_name`}}.ovf",

    "ssh_username": "vagrant",
    "ssh_password": "vagrant",
    "ssh_port": 22,
    "ssh_wait_timeout": "10000s",

    "headless": false,
    "boot_wait": "12s",

    "shutdown_command": "echo 'vagrant'|sudo -S /sbin/halt -h -p"
  },{
    "type": "docker",

    "image": "{{user `docker_user`}}/{{user `base_name`}}",
    "commit": "true"
  }],

  "provisioners": [{
    "type": "ansible-local",
    "playbook_file": "{{user `name`}}.yml",
    "role_paths": ["{{template_dir}}/roles/java"],
    "override": {
      "virtualbox": {
        "extra_arguments": "-s -u vagrant"
      }
    }
  }, {
    "type": "shell",

    "only": ["virtualbox"],

    "inline": [
      "dd if=/dev/zero of=/EMPTY bs=1M",
      "rm -f /EMPTY"
    ],

    "execute_command": "echo 'vagrant' | {{.Vars}} sudo -S -E bash '{{.Path}}'"
  }, {
    "type": "shell",
    "inline": [
      "rm -rf /var/lib/yum/history/* /tmp/* /var/tmp/*"
    ],
    "override": {
      "virtualbox": {
        "execute_command": "echo 'vagrant' | {{.Vars}} sudo -S -E bash '{{.Path}}'"
      }
    }
  }],

  "post-processors": [
    [{
      "type": "vagrant",

      "only": ["virtualbox"],

      "output": "{{user `user_home`}}/boxes/{{user `atlas_user`}}/{{user `name`}}/{{user `name`}}.box",
      "compression_level": 9,
      "keep_input_artifact": true
    }, {
      "type": "atlas",

      "only": ["virtualbox"],

      "token": "{{user `atlas_token`}}",
      "artifact": "{{user `atlas_user`}}/{{user `name`}}",
      "artifact_type": "vagrant.box",
      "metadata": {
        "created_at": "{{timestamp}}",
        "provider": "virtualbox",
        "version": "{{user `version`}}.{{user `timestamp`}}",
        "os": "oracle-linux-6"
      }
    }], [{
      "type": "docker-tag",

      "only": ["docker"],

      "repository": "{{user `docker_user`}}/{{user `name`}}",
      "tag": "{{user `version`}}.ol6.{{user `timestamp`}}"
    },{
      "type": "docker-tag",

      "only": ["docker"],

      "repository": "{{user `docker_user`}}/{{user `name`}}",
      "tag": "{{user `version`}}.ol6",
      "force": true
    },{
      "type": "docker-tag",

      "only": ["docker"],

      "repository": "{{user `docker_user`}}/{{user `name`}}",
      "tag": "{{user `version`}}",
      "force": true
    },{
      "type": "docker-tag",

      "only": ["docker"],

      "repository": "{{user `docker_user`}}/{{user `name`}}",
      "tag": "latest",
      "force": true
    }, {
      "type": "docker-push",

      "only": ["docker"]
    }]
  ]
}
